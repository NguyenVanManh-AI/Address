<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geolocation Example</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<h1>Geolocation Example : <span id="address"></span></h1>
<h1>country code : <span id="country_code"></span></h1>
<script>
    // Khai báo url 
    var url = {
        CountryOthers : [
            'https://vuejs.org/ấccascsacsac',
            'https://getcomposer.org/',
            'https://www.php.net/',
            'https://www.postman.com/downloads/ấccacssacsacsacsacsac',
            'https://github.com/%C3%A2vvsavsavsavsav',
            'https://getcomposer.org/avdvsdvsdvsdvsdvdsvsdvsdvds',
            'https://www.facebook.com/IcassNiuTon',
            'https://docs.google.com/spreadsheets/d/1WkuA02F8yUpJ0U7wl5uuyV9I1stfCRct/edit?fbclid=IwAR1sZrYasfGzqUF-JFBO-qy272t8lTS4qMcU2OkjdgUnoMR9fjRQJrroOus#gid=494795954'
        ],
        USA : [
            'https://techcrunch.com/',
            'https://www.cnet.com/',
            'https://www.engadget.com/',
            'https://www.theverge.com/',
            'https://www.wired.com/'
        ],
        Arab : [
            'https://www.vogue.com/',
            'https://www.gq.com/',
            'https://www.hm.com/',
            'https://www.zara.com/',
            'https://www.asos.com/'
        ],
        Indo : [
            'https://www.openai.com/',
            'https://www.ibm.com/watson/artificial-intelligence',
            'https://ai.google/',
            'https://www.microsoft.com/en-us/ai',
            'https://ai.facebook.com/',
        ]
    };

    // Khai báo mã 	ISO 3166-1-alpha-2 code . http://www.ip2country.net/ip2country/country_code.html
    var Arab_country_code2 = ['SA', 'EG', 'DZ', 'BH', 'KM', 'DJ', 'IQ', 'JO', 'KW', 'LB', 'LY', 'MA', 'MR', 'OM', 'PS', 'QA', 'SO', 'SD', 'SY', 'TN', 'AE', 'YE'];

    var name_country = '';
    var country_code2 = '';

    // Kiểm tra mã IOS ứng với vị trí địa lý 
    function getUserCountry() {
      fetch('https://api.ipgeolocation.io/ipgeo?apiKey=a1f64880c15b486eb1e7e4a58686a316')
        .then(response => response.json())
        .then(data => {
            console.log(data);
            var country = data.country_name;
            console.log("Quốc gia: " + country);
            name_country = data.country_name;
            country_code2 = data.country_code2;
            // Xử lý thông tin quốc gia ở đây
            handleCountryName();
        })
        .catch(error => {
            console.error('Lỗi khi lấy thông tin quốc gia:', error);
        });
    }

    // Xử lý sau khi có được IOS quốc gia 
    function handleCountryName() {
        console.log(name_country);
        var address = window.document.getElementById('address');
        address.innerHTML = name_country;

        var country_code = window.document.getElementById('country_code');
        country_code.innerHTML = country_code2;

        var countryUrls = [];
        if(country_code2.includes(Arab_country_code2)) countryUrls = url.Arab;
        else if (country_code2 == 'US') countryUrls = url.USA;
        else if (country_code2 == 'ID') countryUrls = url.Indo;
        else countryUrls = url.CountryOthers;

        checkLinks(countryUrls);
    }

    // Random link và loại bỏ các link không hoạt động 
    function checkLinks(links) {
        // Kiểm tra xem mảng links có còn phần tử không
        if (links.length === 0) {
        console.log('Không còn link nào để kiểm tra.');
        return;
        }
        // Chọn ngẫu nhiên một liên kết từ mảng
        const randomIndex = Math.floor(Math.random() * links.length);
        const link = links[randomIndex];
    
        fetch("https://api.httpstatus.io/v1/status", {
            "method": "POST",
            "headers": {
                "Content-Type": "application/json; charset=utf-8"
            },
            "body": JSON.stringify({ "requestUrl": link })
        })
        .then((res) => res.text())
        .then((responseText) => {
            // Kiểm tra trạng thái phản hồi
            if (responseText.includes('"statusCode":200')) {
                console.log('Link hoạt động tốt:', link);

                // Redirect nếu tìm thấy link hoạt động tốt . Ngược lại thì tiếp tục tìm và loại cho đến khi tìm thấy link tốt  
                window.location.href = link;
                
            } else {
                console.log('Link không hoạt động:', link);
                // Xóa link khỏi mảng
                links.splice(randomIndex, 1);
                // Tiếp tục kiểm tra các link còn lại
                checkLinks(links);
            }
        })
        .catch((error) => {
            console.log('Lỗi khi kiểm tra link:', error);
            // Xóa link khỏi mảng
            links.splice(randomIndex, 1);
            // Tiếp tục kiểm tra các link còn lại
            checkLinks(links);
        });
    }
      
    // Gọi hàm để lấy quốc gia của người dùng
    getUserCountry();
</script>
</body>
</html>
